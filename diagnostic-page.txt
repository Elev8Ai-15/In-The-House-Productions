app.get('/diagnostic', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Session Diagnostic Tool</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-black text-white p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold mb-8 text-center">üîç Session Diagnostic Tool</h1>
            
            <div id="diagnosticResults" class="space-y-4"></div>
            
            <button onclick="runDiagnostics()" class="mt-8 bg-red-600 text-white px-8 py-4 rounded-lg font-bold w-full">
                RUN FULL DIAGNOSTIC
            </button>
        </div>
        
        <script>
          function displayResult(title, value, status) {
            const color = status === 'success' ? 'green' : status === 'error' ? 'red' : 'yellow';
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è';
            return \`
              <div class="bg-gray-900 p-4 rounded-lg border-2 border-\${color}-500">
                <div class="font-bold text-\${color}-400">\${icon} \${title}</div>
                <div class="mt-2 text-sm font-mono break-all">\${value}</div>
              </div>
            \`;
          }
          
          async function runDiagnostics() {
            const container = document.getElementById('diagnosticResults');
            container.innerHTML = '<div class="text-center text-yellow-400">Running diagnostics...</div>';
            
            let html = '';
            
            // Check 1: Token in localStorage
            const token = localStorage.getItem('authToken');
            html += displayResult(
              '1. Token in localStorage',
              token ? \`Found (length: \${token.length})\\nPreview: \${token.substring(0, 100)}...\` : 'NOT FOUND',
              token ? 'success' : 'error'
            );
            
            // Check 2: User data in localStorage
            const user = localStorage.getItem('user');
            html += displayResult(
              '2. User data in localStorage',
              user || 'NOT FOUND',
              user ? 'success' : 'error'
            );
            
            // Check 3: Token format
            if (token) {
              const validFormat = token.startsWith('eyJ');
              html += displayResult(
                '3. Token format',
                validFormat ? 'Valid JWT format (starts with eyJ)' : 'INVALID FORMAT',
                validFormat ? 'success' : 'error'
              );
              
              // Check 4: Test token with /api/auth/me
              try {
                const meResponse = await fetch('/api/auth/me', {
                  headers: { 'Authorization': \`Bearer \${token}\` }
                });
                const meData = await meResponse.json();
                html += displayResult(
                  '4. Token validation (/api/auth/me)',
                  \`Status: \${meResponse.status}\\nResponse: \${JSON.stringify(meData, null, 2)}\`,
                  meResponse.ok ? 'success' : 'error'
                );
              } catch (error) {
                html += displayResult(
                  '4. Token validation (/api/auth/me)',
                  \`Error: \${error.message}\`,
                  'error'
                );
              }
              
              // Check 5: Test booking creation (dry run)
              try {
                const bookingResponse = await fetch('/api/bookings/create', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': \`Bearer \${token}\`
                  },
                  body: JSON.stringify({
                    serviceType: 'dj',
                    serviceProvider: 'dj_cease',
                    eventDate: '2026-02-01',
                    startTime: '18:00',
                    endTime: '22:00',
                    eventDetails: {
                      eventName: 'Test Event',
                      eventType: 'wedding',
                      venueName: 'Test Venue'
                    }
                  })
                });
                const bookingData = await bookingResponse.json();
                html += displayResult(
                  '5. Booking creation test',
                  \`Status: \${bookingResponse.status}\\nResponse: \${JSON.stringify(bookingData, null, 2)}\`,
                  bookingResponse.ok ? 'success' : 'error'
                );
              } catch (error) {
                html += displayResult(
                  '5. Booking creation test',
                  \`Error: \${error.message}\`,
                  'error'
                );
              }
            } else {
              html += displayResult(
                '3-5. Skipped',
                'No token found, cannot test validation',
                'warning'
              );
            }
            
            // Summary
            html += \`
              <div class="mt-8 p-6 bg-blue-900 rounded-lg">
                <h3 class="text-xl font-bold mb-4">üìã Summary</h3>
                <p class="mb-4">Copy this entire page and send to support.</p>
                <p class="text-sm text-gray-300">Test Time: \${new Date().toISOString()}</p>
              </div>
            \`;
            
            container.innerHTML = html;
          }
          
          // Auto-run on load
          window.addEventListener('DOMContentLoaded', runDiagnostics);
        </script>
    </body>
    </html>
  `)
})
